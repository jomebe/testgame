<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>공 피하기 게임</title>
    <link href="https://fonts.googleapis.com/css2?family=Jua&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            font-family: 'Noto Sans KR', sans-serif;
            color: #fff;
        }
        #game-container {
            position: relative;
            width: 480px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            overflow: hidden;
        }
        canvas {
            background: linear-gradient(to bottom, #0f0c29, #302b63, #24243e);
            border: none;
            border-radius: 10px;
            display: block;
        }
        #score {
            color: white;
            font-size: 28px;
            text-align: center;
            font-weight: bold;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.7);
            font-family: 'Jua', sans-serif;
            letter-spacing: 1px;
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            z-index: 10;
            background-color: rgba(0, 0, 0, 0.6);
            padding: 8px 15px;
            border-radius: 20px;
            margin: 0 auto;
            width: 150px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }
        #game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 36px;
            display: none;
            text-align: center;
            background: rgba(0, 0, 0, 0.8);
            padding: 30px;
            border-radius: 15px;
            width: 80%;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.5s ease-in-out;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, -60%); }
            to { opacity: 1; transform: translate(-50%, -50%); }
        }
        button {
            background: linear-gradient(to right, #4CAF50, #45a049);
            border: none;
            color: white;
            padding: 12px 24px;
            text-align: center;
            font-size: 16px;
            margin: 15px 0;
            cursor: pointer;
            border-radius: 50px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.2);
        }
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
            background: linear-gradient(to right, #45a049, #4CAF50);
        }
        button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 3px rgba(0, 0, 0, 0.2);
        }
        #leaderboard {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            max-height: 250px;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(3px);
        }
        #leaderboard h3 {
            margin-top: 0;
            text-align: center;
            color: #4dd637;
            font-family: 'Jua', sans-serif;
            letter-spacing: 1px;
            font-size: 24px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            margin: 5px 0;
            border-radius: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: background-color 0.2s;
        }
        .leaderboard-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .leaderboard-item span:first-child {
            font-weight: bold;
            color: #fff;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }
        .leaderboard-item span:last-child {
            color: #4dd637;
            font-weight: bold;
        }
        #name-input {
            margin: 15px 0;
            padding: 12px 15px;
            width: 100%;
            box-sizing: border-box;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            background-color: rgba(255, 255, 255, 0.9);
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }
        #name-input:focus {
            outline: none;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1), 0 0 0 3px rgba(76, 175, 80, 0.3);
        }
        #submit-score {
            background: linear-gradient(to right, #2196F3, #1a88da);
        }
        #submit-score:hover {
            background: linear-gradient(to right, #1a88da, #2196F3);
        }
        #toggle-offline {
            background: linear-gradient(to right, #555, #444);
            padding: 8px 15px;
            font-size: 12px;
            border-radius: 20px;
            margin: 0;
        }
        #toggle-offline:hover {
            background: linear-gradient(to right, #444, #555);
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        /* 로딩 애니메이션 개선 */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loader {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #4dd637;
            border-radius: 50%;
            margin: 15px auto;
            animation: spin 1s linear infinite;
        }
        /* 게임 오버 애니메이션 */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .pulse-text {
            animation: pulse 2s infinite;
            color: #ff5e5e;
            font-weight: bold;
            font-family: 'Jua', sans-serif;
        }
        #final-score {
            font-size: 28px;
            color: #4dd637;
            margin: 15px 0;
            font-weight: bold;
        }
        /* 디버깅용 테두리 */
        .debug-border {
            border: 1px solid red !important;
        }
        #auth-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .auth-form {
            background: linear-gradient(to bottom, #1a1a2e, #16213e);
            padding: 30px;
            border-radius: 15px;
            width: 350px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .auth-form h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #4dd637;
            font-family: 'Jua', sans-serif;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: none;
            background: rgba(255, 255, 255, 0.9);
            box-sizing: border-box;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .form-actions button {
            flex: 1;
        }
        
        .toggle-text {
            text-align: center;
            font-size: 14px;
            margin-top: 15px;
            color: #ccc;
        }
        
        .toggle-text span {
            cursor: pointer;
            text-decoration: underline;
        }
        
        .toggle-text span:hover {
            color: #4dd637;
        }
        
        #guest-play-btn {
            width: 100%;
            background: linear-gradient(to right, #555, #444);
            margin-top: 15px;
        }
        
        #user-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.6);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            z-index: 10;
        }
        
        #logout-btn {
            background: transparent;
            color: #ff5e5e;
            padding: 5px 10px;
            margin-left: 10px;
            font-size: 12px;
            box-shadow: none;
        }
        
        #logout-btn:hover {
            background: rgba(255, 94, 94, 0.2);
            transform: none;
        }
        
        .auth-message {
            color: #ff5e5e;
            font-size: 14px;
            text-align: center;
            min-height: 20px;
            margin-bottom: 10px;
        }
        
        .social-login {
            margin-top: 20px;
            text-align: center;
            position: relative;
        }
        
        .social-login::before {
            content: "또는";
            display: block;
            text-align: center;
            color: #ccc;
            font-size: 14px;
            margin-bottom: 15px;
            position: relative;
        }
        
        .social-login::after {
            content: "";
            display: block;
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            position: absolute;
            top: 9px;
            left: 0;
            right: 0;
            z-index: -1;
        }
        
        .social-login::before {
            background: linear-gradient(to bottom, #1a1a2e, #16213e);
            display: inline-block;
            padding: 0 10px;
        }
        
        .google-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 12px;
            background: white;
            color: #333;
            border-radius: 8px;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .google-btn:hover {
            background: #f5f5f5;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .google-btn img {
            width: 24px;
            height: 24px;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="gameCanvas" width="480" height="600"></canvas>
        <div id="score">점수: 0</div>
        <div id="game-over">
            <p class="pulse-text">게임 오버!</p>
            <p id="final-score">최종 점수: 0</p>
            <button id="submit-score">점수 등록하기</button>
            <button id="restart-button">다시 시작</button>
        </div>
        <div id="leaderboard">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3>최고 점수</h3>
                <button id="toggle-offline">오프라인 모드</button>
            </div>
            <div id="leaderboard-items"></div>
        </div>
    </div>

    <!-- 기존 game-container 위에 추가 -->
    <div id="auth-container" style="display: none;">
        <div class="auth-form">
            <h2 id="auth-title">로그인</h2>
            <div id="auth-message" class="auth-message"></div>
            
            <div class="form-group">
                <label for="email">이메일</label>
                <input type="email" id="email" placeholder="이메일을 입력하세요">
            </div>
            
            <div class="form-group">
                <label for="password">비밀번호</label>
                <input type="password" id="password" placeholder="비밀번호를 입력하세요">
            </div>
            
            <div class="form-group" id="nickname-group" style="display: none;">
                <label for="nickname">닉네임</label>
                <input type="text" id="nickname" placeholder="게임에서 사용할 닉네임" maxlength="15">
            </div>
            
            <div class="form-actions">
                <button id="login-btn">로그인</button>
                <button id="register-btn">회원가입</button>
            </div>
            
            <div class="social-login">
                <button id="google-login-btn" class="google-btn">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="구글 로고">
                    구글로 로그인
                </button>
            </div>
            
            <p class="toggle-text">
                <span id="toggle-register">계정이 없으신가요? 회원가입</span>
                <span id="toggle-login" style="display: none;">이미 계정이 있으신가요? 로그인</span>
            </p>
            
            <button id="guest-play-btn">손님으로 플레이</button>
        </div>
    </div>

    <!-- 유저 정보 표시 영역 추가 -->
    <div id="user-info" style="display: none;">
        <span id="user-nickname">손님</span>
        <button id="logout-btn">로그아웃</button>
    </div>

    <!-- Firebase SDK 업데이트 -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <div id="firebase-rules-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1a1a2e; padding: 20px; border-radius: 10px; width: 80%; max-width: 600px; color: white;">
            <h3 style="color: #4dd637;">Firebase 보안 규칙 설정 안내</h3>
            <p>Firebase 콘솔에서 다음과 같이 보안 규칙을 설정해주세요:</p>
            <pre style="background: #222; padding: 15px; overflow: auto; border-radius: 5px; text-align: left;">
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    match /scores/{scoreId} {
      allow read: if true;
      allow write: if request.auth != null;
    }
  }
}
            </pre>
            <p>설정 방법:</p>
            <ol style="text-align: left;">
                <li>Firebase 콘솔 접속</li>
                <li>왼쪽 메뉴에서 "Firestore Database" 선택</li>
                <li>"규칙" 탭 클릭</li>
                <li>위 규칙 복사하여 붙여넣기</li>
                <li>"게시" 버튼 클릭</li>
            </ol>
            <button id="close-rules-modal" style="padding: 10px 20px; background: #4CAF50; border: none; color: white; border-radius: 5px; cursor: pointer;">확인</button>
        </div>
    </div>

    <div class="domain-instruction" style="background: #1a1a2e; padding: 20px; border-radius: 10px; margin: 20px auto; max-width: 600px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: none;">
        <h3 style="color: #4dd637; text-align: center;">Firebase 도메인 승인 방법</h3>
        <ol style="text-align: left; line-height: 1.6;">
            <li>Firebase 콘솔에 로그인: <a href="https://console.firebase.google.com/" target="_blank" style="color: #4dd637;">https://console.firebase.google.com/</a></li>
            <li>프로젝트 'testgame-349b6'를 선택합니다</li>
            <li>왼쪽 메뉴에서 "Authentication" 클릭</li>
            <li>"Settings" 탭 클릭</li>
            <li>"Authorized domains" 섹션 찾기</li>
            <li>"Add domain" 버튼 클릭</li>
            <li>현재 도메인 입력: <span id="current-domain" style="background: #333; padding: 3px 6px; border-radius: 4px;"></span></li>
            <li>"Add" 버튼 클릭</li>
        </ol>
        <p style="margin-top: 15px;">위 단계를 완료한 후 페이지를 새로고침하면 구글 로그인이 작동합니다.</p>
        <button id="close-domain-instruction" style="background: #4dd637; border: none; color: black; padding: 8px 15px; border-radius: 5px; cursor: pointer; display: block; margin: 10px auto;">이해했습니다</button>
    </div>

    <script>
        // Firebase 초기화
        const firebaseConfig = {
            apiKey: "AIzaSyDvpN35A5K4FPWfCJVGSa6OV_KRjH6cpSQ",
            authDomain: "testgame-349b6.firebaseapp.com",
            projectId: "testgame-349b6",
            storageBucket: "testgame-349b6.appspot.com",
            messagingSenderId: "123634890932",
            appId: "1:123634890932:web:ea8d5d3b3dfd133e963fe1",
            measurementId: "G-P1ZXB7L57W"
        };

        // Firebase 초기화 수정
        try {
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const auth = firebase.auth();
            console.log("Firebase 초기화 성공");
            
            // 현재 로그인 상태
            let currentUser = null;
            let isGuestMode = false;
            
            // 페이지 로드 시 인증 상태 확인
            auth.onAuthStateChanged(function(user) {
                if (user) {
                    // 사용자 로그인 상태
                    currentUser = user;
                    
                    // 닉네임 가져오기
                    db.collection('users').doc(user.uid).get()
                        .then((doc) => {
                            if (doc.exists && doc.data().nickname) {
                                // 유저 정보 표시
                                document.getElementById('user-nickname').textContent = doc.data().nickname;
                                document.getElementById('user-info').style.display = 'flex';
                                
                                // 로그인 화면 숨기기
                                document.getElementById('auth-container').style.display = 'none';
                            } else {
                                // 닉네임이 없으면 닉네임 설정 요청
                                showNicknamePrompt();
                            }
                        })
                        .catch((error) => {
                            console.error("사용자 정보 가져오기 오류:", error);
                        });
                } else {
                    // 로그아웃 상태
                    currentUser = null;
                    
                    if (!isGuestMode) {
                        // 로그인 화면 표시
                        document.getElementById('auth-container').style.display = 'flex';
                        document.getElementById('user-info').style.display = 'none';
                    }
                }
            });
            
            // 닉네임 설정 프롬프트
            function showNicknamePrompt() {
                document.getElementById('auth-container').style.display = 'flex';
                document.getElementById('auth-title').textContent = '닉네임 설정';
                document.getElementById('email').parentElement.style.display = 'none';
                document.getElementById('password').parentElement.style.display = 'none';
                document.getElementById('nickname-group').style.display = 'block';
                document.getElementById('login-btn').style.display = 'none';
                document.getElementById('register-btn').textContent = '닉네임 설정';
                document.getElementById('toggle-register').style.display = 'none';
                document.getElementById('toggle-login').style.display = 'none';
                document.getElementById('guest-play-btn').style.display = 'none';
                document.getElementById('google-login-btn').parentElement.style.display = 'none';
                
                // 사용자가 구글 로그인을 통해 들어왔을 경우 기본 닉네임 설정
                if (currentUser && currentUser.displayName) {
                    document.getElementById('nickname').value = currentUser.displayName;
                }
                
                // 닉네임 설정 버튼 이벤트
                document.getElementById('register-btn').onclick = function() {
                    const nickname = document.getElementById('nickname').value.trim();
                    if (!nickname) {
                        document.getElementById('auth-message').textContent = '닉네임을 입력해주세요';
                        return;
                    }
                    
                    // 닉네임 중복 체크
                    checkNicknameAvailability(nickname)
                        .then(isAvailable => {
                            if (isAvailable) {
                                // 닉네임 저장
                                db.collection('users').doc(currentUser.uid).set({
                                    nickname: nickname,
                                    email: currentUser.email,
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                                }, { merge: true })
                                .then(() => {
                                    document.getElementById('user-nickname').textContent = nickname;
                                    document.getElementById('user-info').style.display = 'flex';
                                    document.getElementById('auth-container').style.display = 'none';
                                })
                                .catch((error) => {
                                    document.getElementById('auth-message').textContent = '오류: ' + error.message;
                                });
                            } else {
                                document.getElementById('auth-message').textContent = '이미 사용 중인 닉네임입니다';
                            }
                        })
                        .catch(error => {
                            document.getElementById('auth-message').textContent = '오류: ' + error.message;
                        });
                };
            }
            
            // 닉네임 중복 확인
            function checkNicknameAvailability(nickname) {
                return db.collection('users')
                    .where('nickname', '==', nickname)
                    .get()
                    .then(snapshot => {
                        return snapshot.empty; // true이면 사용 가능
                    });
            }
            
            // 로그인 버튼 이벤트
            document.getElementById('login-btn').addEventListener('click', function() {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                
                if (!email || !password) {
                    document.getElementById('auth-message').textContent = '이메일과 비밀번호를 입력해주세요';
                    return;
                }
                
                auth.signInWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        // 로그인 성공
                        document.getElementById('auth-message').textContent = '';
                    })
                    .catch((error) => {
                        document.getElementById('auth-message').textContent = getKoreanErrorMessage(error.code);
                    });
            });
            
            // 회원가입 버튼 이벤트
            document.getElementById('register-btn').addEventListener('click', function() {
                if (document.getElementById('auth-title').textContent === '회원가입') {
                    const email = document.getElementById('email').value;
                    const password = document.getElementById('password').value;
                    const nickname = document.getElementById('nickname').value.trim();
                    
                    if (!email || !password || !nickname) {
                        document.getElementById('auth-message').textContent = '모든 필드를 입력해주세요';
                        return;
                    }
                    
                    // 닉네임 중복 체크
                    checkNicknameAvailability(nickname)
                        .then(isAvailable => {
                            if (isAvailable) {
                                // 회원가입 진행
                                auth.createUserWithEmailAndPassword(email, password)
                                    .then((userCredential) => {
                                        // 회원가입 성공 시 닉네임 저장
                                        db.collection('users').doc(userCredential.user.uid).set({
                                            nickname: nickname,
                                            email: email,
                                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                                        });
                                    })
                                    .catch((error) => {
                                        document.getElementById('auth-message').textContent = getKoreanErrorMessage(error.code);
                                    });
                            } else {
                                document.getElementById('auth-message').textContent = '이미 사용 중인 닉네임입니다';
                            }
                        });
                }
            });
            
            // 손님으로 플레이 버튼
            document.getElementById('guest-play-btn').addEventListener('click', function() {
                isGuestMode = true;
                document.getElementById('auth-container').style.display = 'none';
                document.getElementById('user-nickname').textContent = '손님';
                document.getElementById('user-info').style.display = 'flex';
            });
            
            // 로그아웃 버튼
            document.getElementById('logout-btn').addEventListener('click', function() {
                auth.signOut()
                    .then(() => {
                        isGuestMode = false;
                        document.getElementById('auth-container').style.display = 'flex';
                        document.getElementById('user-info').style.display = 'none';
                    })
                    .catch((error) => {
                        console.error('로그아웃 오류:', error);
                    });
            });
            
            // 토글 버튼 - 회원가입 폼으로 전환
            document.getElementById('toggle-register').addEventListener('click', function() {
                document.getElementById('auth-title').textContent = '회원가입';
                document.getElementById('nickname-group').style.display = 'block';
                document.getElementById('toggle-register').style.display = 'none';
                document.getElementById('toggle-login').style.display = 'inline';
                document.getElementById('auth-message').textContent = '';
            });
            
            // 토글 버튼 - 로그인 폼으로 전환
            document.getElementById('toggle-login').addEventListener('click', function() {
                document.getElementById('auth-title').textContent = '로그인';
                document.getElementById('nickname-group').style.display = 'none';
                document.getElementById('toggle-register').style.display = 'inline';
                document.getElementById('toggle-login').style.display = 'none';
                document.getElementById('auth-message').textContent = '';
            });
            
            // 에러 메시지 한글화
            function getKoreanErrorMessage(errorCode) {
                switch(errorCode) {
                    case 'auth/user-not-found':
                        return '존재하지 않는 이메일입니다';
                    case 'auth/wrong-password':
                        return '비밀번호가 올바르지 않습니다';
                    case 'auth/email-already-in-use':
                        return '이미 사용 중인 이메일입니다';
                    case 'auth/weak-password':
                        return '비밀번호는 6자 이상이어야 합니다';
                    case 'auth/invalid-email':
                        return '올바르지 않은 이메일 형식입니다';
                    default:
                        return '오류가 발생했습니다: ' + errorCode;
                }
            }
            
            // 캔버스 설정
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            
            // 게임 변수
            let score = 0;
            let gameOver = false;
            const player = {
                x: canvas.width / 2,
                y: canvas.height - 30,
                width: 30,
                height: 30,
                color: '#5DADE2',
                speed: 5,
                borderDanger: 0,  // 경계 위험 타이머 추가
                dangerColor: '#4dd637'  // 초기 색상
            };
            
            let balls = [];
            let enemyLasers = []; // 적 레이저 배열 추가
            let animationId;
            let lastBallSpawn = 0;
            let lastLaserSpawn = 0; // 레이저 스폰 타이머
            let spawnInterval = 1000; // 1초마다 공 생성
            let laserSpawnInterval = 2000; // 레이저 스폰 간격 (밀리초)
            let difficulty = 1;
            
            // 마우스 위치 추적
            let mouseX = player.x;
            
            // 게임 초기화
            function init() {
                score = 0;
                gameOver = false;
                balls = [];
                enemyLasers = []; // 적 레이저 초기화
                difficulty = 1;
                player.x = canvas.width / 2;
                player.borderDanger = 0; // 경계 위험 타이머 초기화
                player.dangerColor = '#4dd637'; // 색상 초기화
                document.getElementById('score').textContent = '점수: 0';
                document.getElementById('game-over').style.display = 'none';
                
                // 게임 루프 시작
                lastBallSpawn = Date.now();
                lastLaserSpawn = Date.now(); // 레이저 타이머 초기화
                animate();
                
                // 로그인 체크
                if (!currentUser && !isGuestMode) {
                    document.getElementById('auth-container').style.display = 'flex';
                }
                
                // 리더보드 불러오기
                loadLeaderboard();
                initStars();
            }
            
            // 공 생성
            function createBall() {
                const ballSize = Math.random() * 20 + 10; // 10-30 사이 크기
                const ball = {
                    x: Math.random() * (canvas.width - ballSize * 2) + ballSize,
                    y: -ballSize,
                    radius: ballSize,
                    color: getRandomColor(),
                    speedY: (Math.random() * 2 + 1) * difficulty
                };
                balls.push(ball);
            }
            
            // 랜덤 색상 생성
            function getRandomColor() {
                const colors = ['#E74C3C', '#9B59B6', '#F1C40F', '#2ECC71', '#F39C12'];
                return colors[Math.floor(Math.random() * colors.length)];
            }
            
            // 적 레이저 생성 함수
            function createEnemyLaser() {
                // 난이도에 따라 레이저 생성 확률 증가
                const laserChance = Math.min(0.7, 0.3 + (difficulty - 1) * 0.1);
                
                if (Math.random() > laserChance) return;
                
                // 레이저 위치 (랜덤)
                const laserX = Math.random() * canvas.width;
                
                const laser = {
                    x: laserX,
                    y: 0, // 화면 상단에서 시작
                    width: 5,
                    height: canvas.height, // 캔버스 전체 높이로 설정
                    speed: 0, // 움직이지 않음
                    color: '#ff3333',
                    createdAt: Date.now(), // 생성 시간 기록
                    lifetime: 2000 // 2초 지속
                };
                
                // 레이저 경고 효과 추가
                // 0.5초 동안 깜빡이는 경고 효과
                showLaserWarning(laserX, 500);
                
                // 경고 후 레이저 추가
                setTimeout(() => {
                    enemyLasers.push(laser);
                }, 500);
            }
            
            // 레이저 경고 효과 함수
            function showLaserWarning(x, duration) {
                const warningEl = document.createElement('div');
                warningEl.style.position = 'absolute';
                warningEl.style.top = '0';
                warningEl.style.left = (x - 10) + 'px';
                warningEl.style.width = '20px';
                warningEl.style.height = canvas.height + 'px';
                warningEl.style.backgroundColor = 'rgba(255, 0, 0, 0.3)';
                warningEl.style.animation = 'blink 0.2s alternate infinite';
                
                // 깜빡임 애니메이션 스타일 추가
                if (!document.getElementById('laser-warn-style')) {
                    const style = document.createElement('style');
                    style.id = 'laser-warn-style';
                    style.textContent = `
                        @keyframes blink {
                            from { opacity: 0.3; }
                            to { opacity: 0.7; }
                        }
                    `;
                    document.head.appendChild(style);
                }
                
                document.getElementById('game-container').appendChild(warningEl);
                
                // 일정 시간 후 경고 제거
                setTimeout(() => {
                    warningEl.remove();
                }, duration);
            }
            
            // 충돌 감지 함수 수정 (레이저 충돌 추가)
            function checkCollision(ball) {
                // 우주선과 공의 거리 계산
                const dx = ball.x - player.x;
                const dy = ball.y - player.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                // 삼각형 충돌을 단순화하여 원으로 처리 (우주선 중심에서 15px 반경)
                return distance < (ball.radius + 20);
            }
            
            // 플레이어와 레이저 충돌 검사
            function checkLaserPlayerCollision(laser) {
                // 레이저가 수직선이므로 플레이어의 x 좌표만 확인하면 됨
                const laserLeft = laser.x - laser.width / 2;
                const laserRight = laser.x + laser.width / 2;
                
                // 플레이어의 히트박스
                const shipLeft = player.x - player.width / 2 - 5;
                const shipRight = player.x + player.width / 2 + 5;
                
                // x축만 비교하여 충돌 체크
                return !(laserRight < shipLeft || laserLeft > shipRight);
            }
            
            // 경계 위험 업데이트
            function updateBorderDanger() {
                const borderThreshold = 40; // 경계에서 얼마나 떨어져 있으면 위험한지 (픽셀)
                
                // 플레이어가 경계에 있는지 확인
                if (player.x < borderThreshold || player.x > canvas.width - borderThreshold) {
                    // 경계에 있으면 위험도 증가
                    player.borderDanger += 1/120; // 60프레임으로 가정하고 1초당 1 증가
                    
                    // 위험도에 따라 색상 변경 (초록->노랑->빨강)
                    if (player.borderDanger < 0.5) {
                        player.dangerColor = '#4dd637'; // 초록색 유지
                    } else if (player.borderDanger < 0.8) {
                        player.dangerColor = lerpColor('#4dd637', '#ffcc00', (player.borderDanger - 0.5) / 0.3);
                    } else if (player.borderDanger < 1) {
                        player.dangerColor = lerpColor('#ffcc00', '#ff3333', (player.borderDanger - 0.8) / 0.2);
                    } else {
                        // 1초 이상 경계에 있으면 게임 오버
                        player.dangerColor = '#ff3333';
                        explodePlayer();
                        gameOver = true;
                        document.getElementById('final-score').textContent = `최종 점수: ${isNaN(score) ? 0 : score}`;
                        document.getElementById('game-over').style.display = 'block';
                        cancelAnimationFrame(animationId);
                        return;
                    }
                } else {
                    // 경계에서 벗어나면 위험도 감소
                    player.borderDanger = Math.max(0, player.borderDanger - 1/120);
                    
                    // 위험도가 낮으면 색상도 원래대로
                    if (player.borderDanger < 0.3) {
                        player.dangerColor = '#4dd637'; // 원래 초록색
                    }
                }
            }
            
            // 색상 보간 함수
            function lerpColor(a, b, amount) { 
                const ah = parseInt(a.replace(/#/g, ''), 16),
                      ar = ah >> 16, ag = (ah >> 8) & 0xff, ab = ah & 0xff,
                      bh = parseInt(b.replace(/#/g, ''), 16),
                      br = bh >> 16, bg = (bh >> 8) & 0xff, bb = bh & 0xff,
                      rr = ar + amount * (br - ar),
                      rg = ag + amount * (bg - ag),
                      rb = ab + amount * (bb - ab);
                return '#' + ((1 << 24) + (rr << 16) + (rg << 8) + rb | 0).toString(16).slice(1);
            }
            
            // 플레이어 폭발 효과
            function explodePlayer() {
                // 여기서 폭발 효과 추가 구현
                // 간단한 예: 캔버스에 빨간색 플래시
                ctx.save();
                ctx.fillStyle = 'rgba(255, 0, 0, 0.5)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.restore();
                
                // 폭발 효과음 재생 (선택적)
                // playExplosionSound();
            }
            
            // 그리기 함수 수정
            function draw() {
                // 캔버스 지우기
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // 배경에 별 효과 추가
                drawStars();
                
                // 플레이어(우주선) 그리기
                ctx.save();
                
                // 우주선 그림자 효과
                ctx.shadowBlur = 15;
                ctx.shadowColor = player.dangerColor; // 위험도에 따라 색상 변경
                
                // 우주선 본체 (삼각형)
                ctx.fillStyle = player.dangerColor; // 위험도에 따라 색상 변경
                ctx.beginPath();
                // 우주선의 앞부분(위)
                ctx.moveTo(player.x, player.y - player.height / 2 - 10);
                // 우주선의 오른쪽 날개
                ctx.lineTo(player.x + player.width / 2 + 5, player.y + player.height / 2);
                // 우주선의 아랫분
                ctx.lineTo(player.x - player.width / 2 - 5, player.y + player.height / 2);
                ctx.closePath();
                ctx.fill();
                
                // 우주선 윈도우 (원)
                ctx.fillStyle = '#85f7ff';
                ctx.beginPath();
                ctx.arc(player.x, player.y - 5, 5, 0, Math.PI * 2);
                ctx.fill();
                
                // 우주선 날개
                ctx.fillStyle = '#3aa424';
                ctx.beginPath();
                // 왼쪽 날개
                ctx.moveTo(player.x - player.width / 2, player.y - 5);
                ctx.lineTo(player.x - player.width * 1.2, player.y + player.height / 4);
                ctx.lineTo(player.x - player.width / 2, player.y + player.height / 4);
                ctx.closePath();
                ctx.fill();
                
                // 오른쪽 날개
                ctx.beginPath();
                ctx.moveTo(player.x + player.width / 2, player.y - 5);
                ctx.lineTo(player.x + player.width * 1.2, player.y + player.height / 4);
                ctx.lineTo(player.x + player.width / 2, player.y + player.height / 4);
                ctx.closePath();
                ctx.fill();
                
                // 엔진 불꽃 효과 (애니메이션)
                const now = Date.now();
                const flameSize = 1 + 0.2 * Math.sin(now / 100); // 불꽃 크기 파동 효과
                
                ctx.fillStyle = '#ff9d00';
                ctx.beginPath();
                ctx.moveTo(player.x - player.width / 3, player.y + player.height / 2);
                ctx.lineTo(player.x, player.y + player.height / 2 + 15 * flameSize);
                ctx.lineTo(player.x + player.width / 3, player.y + player.height / 2);
                ctx.closePath();
                ctx.fill();
                
                // 더 밝은 내부 불꽃
                ctx.fillStyle = '#ffef00';
                ctx.beginPath();
                ctx.moveTo(player.x - player.width / 6, player.y + player.height / 2);
                ctx.lineTo(player.x, player.y + player.height / 2 + 10 * flameSize);
                ctx.lineTo(player.x + player.width / 6, player.y + player.height / 2);
                ctx.closePath();
                ctx.fill();
                
                ctx.restore();
                
                // 적 레이저 그리기
                enemyLasers.forEach(laser => {
                    ctx.save();
                    
                    // 레이저 효과 (그라데이션)
                    const gradient = ctx.createLinearGradient(
                        laser.x, 0,
                        laser.x, canvas.height
                    );
                    gradient.addColorStop(0, 'rgba(255, 102, 102, ' + (laser.opacity || 1) + ')');
                    gradient.addColorStop(0.5, 'rgba(255, 51, 51, ' + (laser.opacity || 1) + ')');
                    gradient.addColorStop(1, 'rgba(153, 0, 0, ' + (laser.opacity || 1) + ')');
                    
                    ctx.fillStyle = gradient;
                    ctx.shadowBlur = 15;
                    ctx.shadowColor = '#ff6666';
                    
                    // 레이저 그리기
                    ctx.beginPath();
                    ctx.roundRect(laser.x - laser.width / 2, 0, laser.width, canvas.height, 2);
                    ctx.fill();
                    
                    // 레이저 후광 효과
                    ctx.globalAlpha = 0.3 * (laser.opacity || 1);
                    ctx.beginPath();
                    ctx.roundRect(laser.x - laser.width * 2, 0, laser.width * 4, canvas.height, 2);
                    ctx.fill();
                    
                    ctx.restore();
                });
                
                // 공 그리기 - 기존 코드 유지
                balls.forEach(ball => {
                    ctx.save();
                    const gradient = ctx.createRadialGradient(
                        ball.x, ball.y, 0,
                        ball.x, ball.y, ball.radius
                    );
                    gradient.addColorStop(0, '#ffffff');
                    gradient.addColorStop(0.7, ball.color);
                    gradient.addColorStop(1, 'rgba(0,0,0,0.3)');
                    
                    ctx.shadowBlur = 15;
                    ctx.shadowColor = ball.color;
                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.restore();
                });
            }
            
            // 별 배경 효과 추가
            let stars = [];
            function initStars() {
                stars = [];
                for (let i = 0; i < 100; i++) {
                    stars.push({
                        x: Math.random() * canvas.width,
                        y: Math.random() * canvas.height,
                        size: Math.random() * 2 + 0.5,
                        opacity: Math.random() * 0.8 + 0.2
                    });
                }
            }
            
            function drawStars() {
                stars.forEach(star => {
                    ctx.fillStyle = `rgba(255, 255, 255, ${star.opacity})`;
                    ctx.beginPath();
                    ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                    ctx.fill();
                });
            }
            
            // 업데이트 함수 수정
            function update() {
                // 플레이어 마우스 따라가기
                player.x += (mouseX - player.x) * 0.1;
                
                // 경계 위험 업데이트
                updateBorderDanger();
                
                // 적 레이저 생성
                const currentTime = Date.now();
                if (currentTime - lastLaserSpawn > laserSpawnInterval) {
                    createEnemyLaser();
                    lastLaserSpawn = currentTime;
                }
                
                // 적 레이저 업데이트
                for (let i = enemyLasers.length - 1; i >= 0; i--) {
                    // 레이저 지속 시간 확인
                    const laserLifetime = currentTime - enemyLasers[i].createdAt;
                    
                    // 지속 시간이 지났으면 제거
                    if (laserLifetime >= enemyLasers[i].lifetime) {
                        enemyLasers.splice(i, 1);
                        continue;
                    }
                    
                    // 지속 시간에 따른 투명도 조절 (점점 사라지게)
                    enemyLasers[i].opacity = 1 - (laserLifetime / enemyLasers[i].lifetime) * 0.7;
                    
                    // 플레이어와 충돌 체크
                    if (checkLaserPlayerCollision(enemyLasers[i])) {
                        gameOver = true;
                        document.getElementById('final-score').textContent = `최종 점수: ${isNaN(score) ? 0 : score}`;
                        document.getElementById('game-over').style.display = 'block';
                        cancelAnimationFrame(animationId);
                        return;
                    }
                }
                
                // 공 움직이기 및 충돌 체크
                for (let i = balls.length - 1; i >= 0; i--) {
                    balls[i].y += balls[i].speedY;
                    
                    // 공이 화면 아래로 나가면 제거하고 점수 추가
                    if (balls[i].y > canvas.height + balls[i].radius) {
                        balls.splice(i, 1);
                        score++;
                        // 점수 표시 전에 NaN 확인
                        document.getElementById('score').textContent = `점수: ${isNaN(score) ? 0 : score}`;
                        // 점수 증가 효과 추가
                        animateScore();
                        
                        // 점수에 따라 난이도 증가
                        difficulty = 1 + Math.floor((isNaN(score) ? 0 : score) / 10) * 0.2;
                        spawnInterval = Math.max(300, 1000 - (isNaN(score) ? 0 : score) * 10);
                    }
                    // 플레이어와 충돌 체크
                    else if (checkCollision(balls[i])) {
                        gameOver = true;
                        // 최종 점수 표시 전에 NaN 확인
                        document.getElementById('final-score').textContent = `최종 점수: ${isNaN(score) ? 0 : score}`;
                        document.getElementById('game-over').style.display = 'block';
                        cancelAnimationFrame(animationId);
                        return;
                    }
                }
                
                // 새로운 공 생성
                if (currentTime - lastBallSpawn > spawnInterval) {
                    createBall();
                    lastBallSpawn = currentTime;
                }
            }
            
            // 점수 증가 애니메이션
            function animateScore() {
                const scoreElement = document.getElementById('score');
                scoreElement.style.transform = 'scale(1.2)';
                scoreElement.style.color = '#4dd637';
                
                setTimeout(() => {
                    scoreElement.style.transform = 'scale(1)';
                    scoreElement.style.color = '#ffffff';
                }, 300);
            }
            
            // 애니메이션 루프
            function animate() {
                if (!gameOver) {
                    animationId = requestAnimationFrame(animate);
                    update();
                    draw();
                }
            }
            
            // 이벤트 리스너
            canvas.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                mouseX = e.clientX - rect.left;
            });
            
            document.getElementById('restart-button').addEventListener('click', init);
            
            // 리더보드 불러오기 함수 수정
            function loadLeaderboard() {
                const leaderboardItems = document.getElementById('leaderboard-items');
                leaderboardItems.innerHTML = `
                    <div style="text-align: center; padding: 15px;">
                        <p>리더보드 로딩 중...</p>
                        <div class="loader"></div>
                    </div>
                `;
                
                try {
                    db.collection('scores')
                        .orderBy('score', 'desc')
                        .limit(10)
                        .get()
                        .then((querySnapshot) => {
                            leaderboardItems.innerHTML = '';
                            if (querySnapshot.empty) {
                                leaderboardItems.innerHTML = '<p>등록된 점수가 없습니다.</p>';
                                return;
                            }
                            
                            querySnapshot.forEach((doc, index) => {
                                const data = doc.data();
                                const item = document.createElement('div');
                                item.className = 'leaderboard-item';
                                
                                // 현재 로그인한 사용자의 점수인지 확인
                                if (currentUser && data.userId === currentUser.uid) {
                                    item.style.backgroundColor = 'rgba(77, 214, 55, 0.2)';
                                }
                                
                                const nameText = String(data.nickname || '익명');
                                const scoreValue = isNaN(Number(data.score)) ? 0 : Number(data.score);
                                
                                const nameSpan = document.createElement('span');
                                nameSpan.textContent = nameText;
                                
                                const scoreSpan = document.createElement('span');
                                scoreSpan.textContent = scoreValue + '점';
                                
                                item.appendChild(nameSpan);
                                item.appendChild(scoreSpan);
                                
                                leaderboardItems.appendChild(item);
                            });
                        })
                        .catch((error) => {
                            console.error('리더보드 로딩 오류:', error);
                            leaderboardItems.innerHTML = '<p>리더보드를 불러오는 중 오류가 발생했습니다.</p>';
                            loadLocalLeaderboard();
                        });
                } catch (error) {
                    console.error('Firestore 쿼리 실행 오류:', error);
                    leaderboardItems.innerHTML = '<p>데이터베이스 연결에 문제가 있습니다.</p>';
                    loadLocalLeaderboard();
                }
            }
            
            // 점수 저장 함수 수정 - 로그인 사용자 정보 활용
            function saveScore(score) {
                // 점수 확실하게 숫자로 변환 후 유효성 검사
                const scoreNum = Number(score);
                if (isNaN(scoreNum)) {
                    alert('유효하지 않은 점수입니다.');
                    return;
                }
                
                // 손님 모드 체크
                if (isGuestMode) {
                    alert('로그인한 사용자만 점수를 저장할 수 있습니다.');
                    return;
                }
                
                // 로그인 체크
                if (!currentUser) {
                    alert('점수를 저장하려면 로그인이 필요합니다.');
                    document.getElementById('auth-container').style.display = 'flex';
                    return;
                }
                
                try {
                    // 닉네임 가져오기
                    db.collection('users').doc(currentUser.uid).get()
                        .then((doc) => {
                            if (doc.exists && doc.data().nickname) {
                                const nickname = doc.data().nickname;
                                
                                // 점수 저장 데이터
                                const scoreData = {
                                    userId: currentUser.uid,
                                    nickname: nickname,
                                    score: scoreNum,
                                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                                };
                                
                                // 사용자별 최고 점수 체크 (인덱스 필요 없는 방식으로 변경)
                                db.collection('scores')
                                    .where('userId', '==', currentUser.uid)
                                    .get()
                                    .then((querySnapshot) => {
                                        let highestScore = 0;
                                        
                                        // 모든 점수를 가져와서 클라이언트에서 최고 점수 계산
                                        querySnapshot.forEach(doc => {
                                            const docScore = doc.data().score || 0;
                                            if (docScore > highestScore) {
                                                highestScore = docScore;
                                            }
                                        });
                                        
                                        let shouldSave = true;
                                        
                                        // 기존 점수가 있는지 확인
                                        if (highestScore > 0) {
                                            // 현재 점수가 최고 점수보다 높으면 저장
                                            if (scoreNum <= highestScore) {
                                                alert(`현재 최고 점수(${highestScore}점)보다 낮아 저장되지 않았습니다.`);
                                                shouldSave = false;
                                            }
                                        }
                                        
                                        if (shouldSave) {
                                            // Firestore에 저장
                                            db.collection('scores').add(scoreData)
                                            .then(() => {
                                                alert('점수가 성공적으로 저장되었습니다!');
                                                loadLeaderboard();
                                            })
                                            .catch((error) => {
                                                console.error('점수 저장 오류:', error);
                                                alert('점수 저장 중 오류가 발생했습니다. 오류: ' + error.message);
                                                // 오류 발생 시 로컬에 저장
                                                saveScoreLocally(scoreNum);
                                            });
                                        }
                                    })
                                    .catch((error) => {
                                        console.error('최고 점수 체크 오류:', error);
                                        alert('점수 확인 중 오류가 발생했습니다. 로컬에 저장합니다.');
                                        // 오류 발생 시 로컬에 저장
                                        saveScoreLocally(scoreNum);
                                    });
                            } else {
                                // 닉네임이 없으면 설정 요청 또는 로컬 저장
                                alert('닉네임 설정이 필요합니다. 임시 저장합니다.');
                                saveScoreLocally(scoreNum);
                            }
                        })
                        .catch((error) => {
                            console.error('사용자 정보 조회 오류:', error);
                            alert('사용자 정보를 불러오는 중 오류가 발생했습니다. 로컬에 저장합니다.');
                            saveScoreLocally(scoreNum);
                        });
                } catch (error) {
                    console.error('Firestore 저장 오류:', error);
                    alert('데이터베이스 연결에 문제가 있습니다. 로컬에 저장합니다.');
                    saveScoreLocally(scoreNum);
                }
            }
            
            // 점수 제출 버튼 리스너 수정
            document.getElementById('submit-score').addEventListener('click', () => {
                // NaN 체크 추가
                const finalScore = isNaN(score) ? 0 : score;
                saveScore(finalScore);
            });
            
            // 오프라인 모드 전환 버튼 이벤트 리스너
            document.getElementById('toggle-offline').addEventListener('click', function() {
                const useLocalStorage = localStorage.getItem('useLocalLeaderboard') === 'true';
                localStorage.setItem('useLocalLeaderboard', !useLocalStorage);
                
                if (!useLocalStorage) {
                    this.textContent = '온라인 모드';
                    this.style.backgroundColor = '#2196F3';
                    loadLocalLeaderboard();
                    alert('오프라인 모드로 전환되었습니다. 로컬 저장소를 사용합니다.');
                } else {
                    this.textContent = '오프라인 모드';
                    this.style.backgroundColor = '#555';
                    loadLeaderboard();
                    alert('온라인 모드로 전환되었습니다. Firebase를 사용합니다.');
                }
            });
            
            // 초기 모드 설정
            window.addEventListener('DOMContentLoaded', function() {
                const useLocalStorage = localStorage.getItem('useLocalLeaderboard') === 'true';
                const btn = document.getElementById('toggle-offline');
                if (useLocalStorage) {
                    btn.textContent = '온라인 모드';
                    btn.style.backgroundColor = '#2196F3';
                    loadLocalLeaderboard();
                }
            });
            
            // 구글 로그인 기능 복구
            // Firebase 초기화 코드 뒤에 추가해야 합니다.
            try {
                // 구글 로그인 제공자 설정
                const googleProvider = new firebase.auth.GoogleAuthProvider();
                googleProvider.setCustomParameters({
                    prompt: 'select_account'
                });
                
                // 구글 로그인 버튼 이벤트 수정
                document.getElementById('google-login-btn').addEventListener('click', function() {
                    document.getElementById('auth-message').textContent = '구글 로그인 진행 중...';
                    
                    // Firebase 콘솔로 바로 이동할 수 있는 링크 표시
                    const authDomain = firebase.app().options.authDomain;
                    document.getElementById('auth-message').innerHTML = `
                        <span>구글 로그인 진행 중...</span><br>
                        <small style="display: block; margin-top: 8px;">문제가 발생하면 <a href="https://console.firebase.google.com/project/testgame-349b6/authentication/settings" target="_blank" style="color: #4dd637; text-decoration: underline;">Firebase 콘솔</a>에서 도메인 '${window.location.hostname}'을 추가하세요.</small>
                    `;
                    
                    // 실제 구글 로그인 진행
                    auth.signInWithPopup(googleProvider)
                        .then((result) => {
                            // 로그인 성공 시 처리
                            const user = result.user;
                            
                            // 사용자 정보 DB에 저장 또는 업데이트
                            db.collection('users').doc(user.uid).get()
                                .then((doc) => {
                                    if (!doc.exists) {
                                        // 첫 로그인 시 사용자 정보 생성
                                        return db.collection('users').doc(user.uid).set({
                                            email: user.email,
                                            nickname: user.displayName || null,
                                            photoURL: user.photoURL || null,
                                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                                        });
                                    }
                                })
                                .then(() => {
                                    // 로그인 완료 후 UI 업데이트
                                    document.getElementById('auth-container').style.display = 'none';
                                    document.getElementById('user-nickname').textContent = user.displayName || '사용자';
                                    document.getElementById('user-info').style.display = 'flex';
                                    
                                    // 로그인 메시지 초기화
                                    document.getElementById('auth-message').textContent = '';
                                })
                                .catch(error => {
                                    console.error("사용자 정보 저장 오류:", error);
                                    // 오류가 있어도 로그인은 완료
                                    document.getElementById('auth-container').style.display = 'none';
                                    document.getElementById('user-nickname').textContent = user.displayName || '사용자';
                                    document.getElementById('user-info').style.display = 'flex';
                                });
                        })
                        .catch((error) => {
                            console.error('Google 로그인 오류:', error);
                            
                            if (error.code === 'auth/popup-closed-by-user') {
                                document.getElementById('auth-message').textContent = '로그인 창이 닫혔습니다.';
                            } 
                            else if (error.code === 'auth/unauthorized-domain') {
                                // 도메인 인증 오류일 경우 상세 안내
                                document.getElementById('auth-message').innerHTML = `
                                    <span style="color: #ff9800; font-weight: bold;">도메인 인증 오류</span><br>
                                    <p style="margin: 10px 0; font-size: 14px;">
                                        현재 도메인(${window.location.hostname})이 Firebase에 등록되지 않았습니다.
                                    </p>
                                    <a href="https://console.firebase.google.com/project/testgame-349b6/authentication/settings" target="_blank" class="google-btn" style="margin-top: 10px; background: #4dd637; color: black; font-size: 14px; padding: 8px;">
                                        Firebase 콘솔에서 도메인 추가하기
                                    </a>
                                    <p style="margin: 10px 0; color: #ccc; font-size: 13px;">
                                        Firebase 콘솔 > Authentication > Settings > Authorized domains에서 도메인을 추가한 후 새로고침하세요.
                                    </p>
                                `;
                            }
                            else {
                                document.getElementById('auth-message').textContent = '구글 로그인 중 오류가 발생했습니다: ' + error.message;
                            }
                        });
                });
                
                // 도메인 상태 표시 (Firebase 콘솔로 이동하는 버튼 추가)
                function addFirebaseConsoleLink() {
                    const messageElement = document.getElementById('auth-message');
                    const currentDomain = window.location.hostname;
                    
                    // 로컬호스트가 아닌 경우에만 표시
                    if (currentDomain !== 'localhost' && currentDomain !== '127.0.0.1') {
                        messageElement.innerHTML += `
                            <div style="margin-top: 10px; font-size: 13px; padding: 5px; background: rgba(0,0,0,0.2); border-radius: 5px;">
                                현재 도메인: ${currentDomain}<br>
                                <a href="https://console.firebase.google.com/project/testgame-349b6/authentication/settings" target="_blank" style="color: #4dd637; text-decoration: underline;">
                                    Firebase 콘솔에서 도메인 추가하기
                                </a>
                            </div>
                        `;
                    }
                }
                
                // 페이지 로드 시 Firebase 콘솔 링크 추가
                setTimeout(addFirebaseConsoleLink, 1000);
            } catch (error) {
                console.error("구글 로그인 설정 오류:", error);
                document.getElementById('auth-message').textContent = '로그인 기능 초기화 중 오류가 발생했습니다.';
            }
            
            // 게임 시작
            init();
        } catch (error) {
            console.error("Firebase 초기화 오류:", error);
            // Firebase 연결 실패 시 로컬 리더보드 사용
            const localLeaderboard = [];
            
            function loadLeaderboard() {
                const leaderboardItems = document.getElementById('leaderboard-items');
                leaderboardItems.innerHTML = '<p>오프라인 모드 - 로컬 리더보드</p>';
                
                if (localLeaderboard.length === 0) {
                    leaderboardItems.innerHTML += '<p>등록된 점수가 없습니다.</p>';
                    return;
                }
                
                localLeaderboard.sort((a, b) => b.score - a.score);
                
                localLeaderboard.forEach((entry, index) => {
                    if (index < 10) { // 상위 10개만 표시
                        const item = document.createElement('div');
                        item.className = 'leaderboard-item';
                        
                        // 순위 텍스트 제거
                        const nameSpan = document.createElement('span');
                        nameSpan.textContent = entry.name || '익명';  // 순위(N.) 제거
                        
                        const scoreSpan = document.createElement('span');
                        scoreSpan.textContent = (isNaN(entry.score) ? 0 : entry.score) + '점';
                        
                        item.appendChild(nameSpan);
                        item.appendChild(scoreSpan);
                        
                        leaderboardItems.appendChild(item);
                    }
                });
            }
            
            function saveScore(name, score) {
                if (!name.trim()) {
                    alert('닉네임을 입력해주세요!');
                    return;
                }
                
                const trimmedName = String(name.trim());
                const scoreNum = Number(score);
                
                // 로컬에서 이름 중복 체크
                let localScores = [];
                try {
                    localScores = JSON.parse(localStorage.getItem('ballGameScores') || '[]');
                    if (!Array.isArray(localScores)) {
                        localScores = [];
                    }
                } catch (e) {
                    localScores = [];
                }
                
                // 이름 중복 체크
                const nameExists = localScores.some(entry => 
                    String(entry.name).toLowerCase() === trimmedName.toLowerCase()
                );
                
                if (nameExists) {
                    alert('이미 사용 중인 닉네임입니다. 다른 닉네임을 사용해주세요.');
                    return;
                }
                
                localLeaderboard.push({
                    name: trimmedName,
                    score: scoreNum,
                    timestamp: new Date().toISOString()
                });
                
                // 로컬 스토리지에도 저장
                localScores.push({
                    name: trimmedName,
                    score: scoreNum,
                    timestamp: new Date().toISOString()
                });
                localStorage.setItem('ballGameScores', JSON.stringify(localScores));
                
                alert('오프라인 모드: 점수가 로컬에 저장되었습니다!');
                document.getElementById('name-input').value = '';
                loadLeaderboard();
            }
        }

        // loadLocalLeaderboard 함수 개선
        function loadLocalLeaderboard() {
            console.log("로컬 리더보드 로딩 시작");
            const leaderboardItems = document.getElementById('leaderboard-items');
            leaderboardItems.innerHTML = '<p>로컬 리더보드</p>';
            
            try {
                let localScores = [];
                try {
                    const rawData = localStorage.getItem('ballGameScores');
                    console.log("로컬 스토리지 데이터:", rawData);
                    
                    if (!rawData) {
                        console.log("로컬 스토리지에 데이터 없음");
                        localScores = [];
                    } else {
                        localScores = JSON.parse(rawData);
                        console.log("파싱된 데이터:", localScores);
                        
                        if (!Array.isArray(localScores)) {
                            console.log("데이터가 배열이 아님, 빈 배열로 초기화");
                            localScores = [];
                        }
                    }
                } catch (e) {
                    console.error('로컬 스토리지 파싱 오류:', e);
                    localScores = [];
                }
                
                if (localScores.length === 0) {
                    console.log("점수 데이터 없음");
                    leaderboardItems.innerHTML += '<p>등록된 점수가 없습니다.</p>';
                    return;
                }
                
                console.log("필터링 전 점수 데이터:", localScores);
                
                // 더 엄격한 데이터 필터링
                localScores = localScores.filter(entry => {
                    if (!entry || typeof entry !== 'object') {
                        console.log("유효하지 않은 항목 제거:", entry);
                        return false;
                    }
                    
                    if (!entry.name) {
                        console.log("이름 없는 항목:", entry);
                        entry.name = '익명';
                    }
                    
                    // 점수를 명시적으로 숫자로 변환
                    const numScore = Number(entry.score);
                    if (isNaN(numScore)) {
                        console.log("유효하지 않은 점수 감지:", entry.score);
                        entry.score = 0;
                        return false; // 유효하지 않은 점수는 제외
                    }
                    
                    // 점수 필드를 명시적으로 숫자로 저장
                    entry.score = numScore;
                    return true;
                });
                
                console.log("필터링 후 점수 데이터:", localScores);
                
                // 점수 내림차순 정렬
                localScores.sort((a, b) => Number(b.score) - Number(a.score));
                console.log("정렬된 데이터:", localScores);
                
                // 리더보드 초기화
                leaderboardItems.innerHTML = '<p>로컬 리더보드</p>';
                
                // 상위 10개만 표시
                for (let i = 0; i < Math.min(localScores.length, 10); i++) {
                    const entry = localScores[i];
                    const item = document.createElement('div');
                    item.className = 'leaderboard-item';
                    
                    // 순위 텍스트 제거
                    const name = String(entry.name || '익명');
                    let score = 0;
                    try {
                        score = Number(entry.score);
                        if (isNaN(score)) score = 0;
                    } catch (e) {
                        score = 0;
                    }
                    
                    // 순위 텍스트 제거하고 이름만 표시
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = name;  // 순위(N.) 제거
                    
                    const scoreSpan = document.createElement('span');
                    scoreSpan.textContent = score + '점';
                    
                    item.appendChild(nameSpan);
                    item.appendChild(scoreSpan);
                    
                    leaderboardItems.appendChild(item);
                }
                
                // 정리된 데이터로 로컬 스토리지 업데이트
                localStorage.setItem('ballGameScores', JSON.stringify(localScores));
                console.log("로컬 리더보드 로딩 완료");
            } catch (error) {
                console.error('로컬 리더보드 처리 오류:', error);
                leaderboardItems.innerHTML = '<p>로컬 리더보드</p><p>로컬 데이터 처리 중 오류가 발생했습니다.</p>';
            }
        }
    </script>
</body>
</html>
